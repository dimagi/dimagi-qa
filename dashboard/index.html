<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QA Automation Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px 14px; min-width:170px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media(min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }
    select { padding:8px; border-radius:10px; border:1px solid #ccc; }
    h2 { margin: 0 0 10px; }
    canvas { background:#fff; border:1px solid #eee; border-radius:12px; padding:10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size: 14px; }
  </style>
</head>
<body>
  <h2>QA Automation Dashboard</h2>

  <div class="row" style="margin-bottom:14px;">
    <label>Suite:
      <select id="suite"></select>
    </label>
    <label>Environment:
      <select id="env"></select>
    </label>
    <label>Time window:
      <select id="window">
        <option value="24h">Last 24h</option>
        <option value="7d" selected>Last 7d</option>
        <option value="30d">Last 30d</option>
        <option value="all">All</option>
      </select>
    </label>
  </div>

  <div class="row" id="cards" style="margin-bottom:16px;"></div>

  <div class="grid">
    <div>
      <h3>Pass/Fail by Environment</h3>
      <canvas id="envBar" height="130"></canvas>
    </div>
    <div>
      <h3>Fail Rate Trend (daily)</h3>
      <canvas id="trend" height="130"></canvas>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div>
      <h3>Top Failing Suites</h3>
      <canvas id="topSuites" height="140"></canvas>
    </div>
    <div>
      <h3>Recent Runs (filtered)</h3>
      <table>
        <thead><tr><th>Time</th><th>Env</th><th>Suite</th><th>Status</th><th>Fail</th><th>Reruns</th></tr></thead>
        <tbody id="runs"></tbody>
      </table>
    </div>
  </div>

<script>
  let ALL = [];
  let charts = {};

  function parseIso(ts){
    // expects ISO; supports "...Z"
    return new Date(ts);
  }

  function withinWindow(run, win){
    if(win === "all") return true;
    const now = new Date();
    const t = parseIso(run.timestamp_utc || run.timestamp || run.time || "");
    if(isNaN(t.getTime())) return true; // if missing timestamp, don't drop it
    const ms = now - t;
    const limits = { "24h": 24*3600e3, "7d": 7*24*3600e3, "30d": 30*24*3600e3 };
    return ms <= limits[win];
  }

  function uniq(arr){ return [...new Set(arr)].sort(); }

  function getFiltered(){
    const suite = document.getElementById("suite").value;
    const env = document.getElementById("env").value;
    const win = document.getElementById("window").value;

    return ALL.filter(r => {
      if(!withinWindow(r, win)) return false;
      if(env !== "All" && (r.env || r.environment) !== env) return false;
      if(suite !== "All" && (r.suite || r.workflow || r.testsuite) !== suite) return false;
      return true;
    }).sort((a,b) => (parseIso(b.timestamp_utc||"") - parseIso(a.timestamp_utc||"")));
  }

  function sum(obj, k){ return (obj[k]||0); }

  function renderCards(rows){
    const runs = rows.length;
    const passRuns = rows.filter(r => (r.status||"").toLowerCase() === "pass").length;
    const failRuns = runs - passRuns;

    const totalFail = rows.reduce((acc,r)=> acc + Number(r.fail_count || r.failed || r.failures || 0), 0);
    const totalPass = rows.reduce((acc,r)=> acc + Number(r.pass_count || r.passed || 0), 0);
    const totalSkip = rows.reduce((acc,r)=> acc + Number(r.skip_count || r.skipped || 0), 0);
    const reruns = rows.reduce((acc,r)=> acc + Number(r.rerun_count || r.reruns || 0), 0);

    const cards = [
      ["Runs", runs],
      ["✅ Passed runs", passRuns],
      ["❌ Failed runs", failRuns],
      ["Fail count (events)", totalFail],
      ["Pass count", totalPass],
      ["Skip count", totalSkip],
      ["Reruns", reruns],
    ];

    const el = document.getElementById("cards");
    el.innerHTML = "";
    for(const [k,v] of cards){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<div style="font-size:13px;color:#666">${k}</div><div style="font-size:24px;font-weight:700">${v}</div>`;
      el.appendChild(c);
    }
  }

  function renderEnvBar(rows){
    const envs = uniq(rows.map(r => (r.env||r.environment||"unknown")));
    const pass = envs.map(e => rows.filter(r => (r.env||r.environment)===e && (r.status||"").toLowerCase()==="pass").length);
    const fail = envs.map(e => rows.filter(r => (r.env||r.environment)===e && (r.status||"").toLowerCase()!=="pass").length);

    const ctx = document.getElementById("envBar");
    charts.envBar?.destroy();
    charts.envBar = new Chart(ctx, {
      type: "bar",
      data: { labels: envs, datasets: [
        { label:"Passed runs", data: pass },
        { label:"Failed runs", data: fail },
      ]},
      options: { responsive:true, plugins:{legend:{position:"bottom"}}, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}} }
    });
  }

  function dayKey(ts){
    const d = parseIso(ts);
    if(isNaN(d.getTime())) return "unknown";
    return d.toISOString().slice(0,10);
  }

  function renderTrend(rows){
    // bucket per day: failRate = failedRuns/totalRuns
    const buckets = {};
    for(const r of rows){
      const k = dayKey(r.timestamp_utc||r.timestamp||"");
      buckets[k] = buckets[k] || { total:0, fail:0 };
      buckets[k].total += 1;
      if((r.status||"").toLowerCase() !== "pass") buckets[k].fail += 1;
    }
    const keys = Object.keys(buckets).filter(k=>k!=="unknown").sort();
    const rate = keys.map(k => buckets[k].total ? (buckets[k].fail / buckets[k].total * 100) : 0);

    const ctx = document.getElementById("trend");
    charts.trend?.destroy();
    charts.trend = new Chart(ctx, {
      type: "line",
      data: { labels: keys, datasets: [{ label:"Fail rate (%)", data: rate }]},
      options: { responsive:true, plugins:{legend:{position:"bottom"}}, scales:{y:{beginAtZero:true}} }
    });
  }

  function renderTopSuites(rows){
    const map = {};
    for(const r of rows){
      const suite = (r.suite || r.workflow || r.testsuite || "unknown");
      if((r.status||"").toLowerCase() === "pass") continue;
      map[suite] = (map[suite]||0) + 1;
    }
    const items = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labels = items.map(x=>x[0]);
    const data = items.map(x=>x[1]);

    const ctx = document.getElementById("topSuites");
    charts.topSuites?.destroy();
    charts.topSuites = new Chart(ctx, {
      type:"bar",
      data:{ labels, datasets:[{ label:"Failed runs", data }]},
      options:{ responsive:true, plugins:{legend:{position:"bottom"}}, scales:{y:{beginAtZero:true}} }
    });
  }

  function renderRunsTable(rows){
    const tbody = document.getElementById("runs");
    tbody.innerHTML = "";
    for(const r of rows.slice(0,15)){
      const tr = document.createElement("tr");
      const ts = r.timestamp_utc || r.timestamp || "";
      tr.innerHTML = `
        <td>${ts ? ts.replace("T"," ").replace("Z"," UTC") : "-"}</td>
        <td>${r.env || r.environment || "-"}</td>
        <td>${r.suite || r.workflow || r.testsuite || "-"}</td>
        <td>${r.status || "-"}</td>
        <td>${r.fail_count ?? r.failed ?? r.failures ?? 0}</td>
        <td>${r.rerun_count ?? r.reruns ?? 0}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function refresh(){
    const rows = getFiltered();
    renderCards(rows);
    renderEnvBar(rows);
    renderTrend(rows);
    renderTopSuites(rows);
    renderRunsTable(rows);
  }

  async function load(){
    const res = await fetch("./data/runs.jsonl", { cache: "no-store" });
    const txt = await res.text();
    ALL = txt.split("\n").map(l => l.trim()).filter(Boolean).map(l => {
      try { return JSON.parse(l); } catch(e){ return null; }
    }).filter(Boolean);

    // Build dropdown options from data
    const suites = uniq(ALL.map(r => (r.suite || r.workflow || r.testsuite || "unknown")));
    const envs = uniq(ALL.map(r => (r.env || r.environment || "unknown")));

    const suiteSel = document.getElementById("suite");
    suiteSel.innerHTML = `<option>All</option>` + suites.map(s=>`<option>${s}</option>`).join("");

    const envSel = document.getElementById("env");
    envSel.innerHTML = `<option>All</option>` + envs.map(e=>`<option>${e}</option>`).join("");

    suiteSel.addEventListener("change", refresh);
    envSel.addEventListener("change", refresh);
    document.getElementById("window").addEventListener("change", refresh);

    refresh();
  }

  load();
</script>
</body>
</html>
