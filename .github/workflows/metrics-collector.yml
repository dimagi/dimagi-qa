name: Metrics Collector

on:
  workflow_run:
    workflows:
      - "HQ Smoke Tests"
      - "Python Request API"
      - "CO BHA Smoke Tests"
      - "Lookup table Tests"
      - "Case Search Tests"
      - "Case Search Split Screen Tests"
      - "Data Dictionary Tests"
      - "Elastic Search Tests"
      - "Export Tests"
      - "Find Data by ID Tests"
      - "Formplayer Tests"
      - "Multi Select Tests"
      - "Priority Escape Defects Tests"
      - "Power BI Tests"
    types: [completed]

  workflow_dispatch:
    inputs:
      run_id:
        description: "Run ID to ingest (optional)"
        required: false
        type: string

  # Daily digest (10:00 AM IST)
  schedule:
    - cron: "30 4 * * *"

permissions:
  contents: write
  actions: read
  pages: write
  id-token: write

concurrency:
  group: metrics-collector
  cancel-in-progress: false

jobs:
  collect:
    if: >
      (github.event_name == 'workflow_run'
       && github.event.workflow_run.conclusion != 'cancelled')
      || (github.event_name == 'workflow_dispatch' && inputs.run_id != '')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout metrics branch
        uses: actions/checkout@v4
        with:
          ref: metrics
          fetch-depth: 0

      - name: Determine run id
        id: runid
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RID=${{ inputs.run_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "RID=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download run-summary artifacts
        id: dl
        uses: actions/github-script@v7
        with:
          script: |
            const runId = Number("${{ steps.runid.outputs.RID }}");
            const { owner, repo } = context.repo;

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner, repo, run_id: runId
            });

            const targets = artifacts.data.artifacts.filter(a =>
              a.name.startsWith("run-summary")
            );

            if (!targets.length) {
              core.notice("No run-summary artifacts found.");
              core.setOutput("FOUND", "false");
              return;
            }

            const fs = require("fs");
            for (const a of targets) {
              const dl = await github.rest.actions.downloadArtifact({
                owner, repo, artifact_id: a.id, archive_format: "zip"
              });
              fs.writeFileSync(`${a.name}.zip`, Buffer.from(dl.data));
            }

            core.setOutput("FOUND", "true");

      - name: Extract run summaries
        if: steps.dl.outputs.FOUND == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y unzip
          mkdir -p incoming
          unzip -o "*.zip" -d incoming

      - name: Append to metrics dataset
        if: steps.dl.outputs.FOUND == 'true'
        run: |
          mkdir -p metrics
          touch metrics/runs.jsonl

          find incoming -name "run_summary.json" | while read f; do
            python - <<'PY'
          import json, sys
          with open(sys.argv[1]) as fh:
              print(json.dumps(json.load(fh)))
          PY
          "$f" >> metrics/runs.jsonl
          done

      - name: Commit dataset update
        if: steps.dl.outputs.FOUND == 'true'
        run: |
          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"
          git add metrics/runs.jsonl
          git commit -m "Metrics update from run ${{ steps.runid.outputs.RID }}" || echo "No changes"
          git push origin metrics

  publish_dashboard:
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Checkout metrics branch
        uses: actions/checkout@v4
        with:
          ref: metrics

      - name: Build Pages root
        run: |
          mkdir -p data
          touch metrics/runs.jsonl
          cp metrics/runs.jsonl data/runs.jsonl
          cp dashboard/index.html index.html
          touch .nojekyll

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  daily_digest:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout metrics branch
        uses: actions/checkout@v4
        with:
          ref: metrics

      - name: Post/update Slack dashboard message
        env:
          SLACK_QA_BOT_TOKEN: ${{ secrets.SLACK_QA_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID_DASHBOARD }}
        run: |
          pip install --quiet slack_sdk
          python - <<'PY'
          import json, os
          from pathlib import Path
          from slack_sdk import WebClient

          client = WebClient(token=os.environ["SLACK_QA_BOT_TOKEN"])
          channel = os.environ["SLACK_CHANNEL_ID"]

          msg = "ðŸ“Š *QA Automation Dashboard*\nhttps://dimagi.github.io/dimagi-qa/"

          state = Path("metrics/slack_dashboard_message.json")
          ts = json.loads(state.read_text()).get("ts") if state.exists() else None

          if ts:
            client.chat_update(channel=channel, ts=ts, text=msg)
          else:
            resp = client.chat_postMessage(channel=channel, text=msg)
            state.write_text(json.dumps({"ts": resp["ts"]}))

          PY

      - name: Commit Slack message state
        run: |
          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"
          git add metrics/slack_dashboard_message.json
          git commit -m "Update Slack dashboard message" || echo "No changes"
          git push origin metrics
